suite: Test Service Template
templates:
  - service.yaml
tests:
  # =========================================================================
  # Empty / no-render cases
  # =========================================================================
  - it: should not render when services is empty
    set:
      services: {}
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when service is explicitly disabled
    set:
      services:
        api:
          enabled: false
          targetDeployment: api
          ports:
            - name: http
              port: 80
    asserts:
      - hasDocuments:
          count: 0

  - it: should render when enabled is explicitly true
    set:
      services:
        api:
          enabled: true
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Service

  # =========================================================================
  # Naming and namespace
  # =========================================================================
  - it: should set correct resource name
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-golden-chart-api

  - it: should use fullnameOverride
    set:
      fullnameOverride: custom
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.name
          value: custom-api

  - it: should use namespaceOverride
    set:
      namespaceOverride: custom-ns
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-ns

  # =========================================================================
  # Service types
  # =========================================================================
  - it: should default to ClusterIP type
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should support LoadBalancer type
    set:
      services:
        api:
          type: LoadBalancer
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should support NodePort type
    set:
      services:
        api:
          type: NodePort
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
          nodePorts:
            http: 30080
    asserts:
      - equal:
          path: spec.type
          value: NodePort
      - equal:
          path: spec.ports[0].nodePort
          value: 30080

  - it: should not render nodePort for ClusterIP type
    set:
      services:
        api:
          type: ClusterIP
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
          nodePorts:
            http: 30080
    asserts:
      - isNull:
          path: spec.ports[0].nodePort

  # =========================================================================
  # LoadBalancer options
  # =========================================================================
  - it: should set loadBalancerIP for LoadBalancer type
    set:
      services:
        api:
          type: LoadBalancer
          loadBalancerIP: "10.0.0.1"
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.loadBalancerIP
          value: "10.0.0.1"

  - it: should not set loadBalancerIP for ClusterIP type
    set:
      services:
        api:
          type: ClusterIP
          loadBalancerIP: "10.0.0.1"
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - isNull:
          path: spec.loadBalancerIP

  - it: should set loadBalancerSourceRanges
    set:
      services:
        api:
          type: LoadBalancer
          targetDeployment: api
          loadBalancerSourceRanges:
            - "10.0.0.0/8"
            - "172.16.0.0/12"
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.loadBalancerSourceRanges
          value:
            - "10.0.0.0/8"
            - "172.16.0.0/12"

  # =========================================================================
  # ClusterIP
  # =========================================================================
  - it: should set explicit clusterIP
    set:
      services:
        api:
          clusterIP: None
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.clusterIP
          value: None

  - it: should not set clusterIP when not specified
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - isNull:
          path: spec.clusterIP

  # =========================================================================
  # External traffic policy
  # =========================================================================
  - it: should set externalTrafficPolicy
    set:
      services:
        api:
          type: LoadBalancer
          externalTrafficPolicy: Local
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.externalTrafficPolicy
          value: Local

  - it: should not set externalTrafficPolicy when not specified
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - isNull:
          path: spec.externalTrafficPolicy

  # =========================================================================
  # Session affinity
  # =========================================================================
  - it: should set sessionAffinity
    set:
      services:
        api:
          targetDeployment: api
          sessionAffinity: ClientIP
          sessionAffinityConfig:
            clientIP:
              timeoutSeconds: 10800
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.sessionAffinity
          value: ClientIP
      - equal:
          path: spec.sessionAffinityConfig.clientIP.timeoutSeconds
          value: 10800

  - it: should not set sessionAffinity when not specified
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - isNull:
          path: spec.sessionAffinity
      - isNull:
          path: spec.sessionAffinityConfig

  # =========================================================================
  # Ports
  # =========================================================================
  - it: should configure single port
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.ports[0].targetPort
          value: http
      - equal:
          path: spec.ports[0].protocol
          value: TCP

  - it: should configure multiple ports
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
            - name: https
              port: 443
              targetPort: 8443
            - name: grpc
              port: 9090
              targetPort: 9090
              protocol: TCP
    asserts:
      - lengthEqual:
          path: spec.ports
          count: 3
      - equal:
          path: spec.ports[2].name
          value: grpc

  - it: should default port protocol to TCP
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.ports[0].protocol
          value: TCP

  - it: should support UDP protocol
    set:
      services:
        dns:
          targetDeployment: dns
          ports:
            - name: dns
              port: 53
              targetPort: 53
              protocol: UDP
    asserts:
      - equal:
          path: spec.ports[0].protocol
          value: UDP

  # =========================================================================
  # Selectors
  # =========================================================================
  - it: should target correct deployment with selector
    set:
      services:
        api:
          targetDeployment: my-api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: spec.selector
          value:
            app.kubernetes.io/name: golden-chart
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/component: my-api

  - it: should use generic selector when no targetDeployment
    set:
      services:
        api:
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: spec.selector
          value:
            app.kubernetes.io/name: golden-chart
            app.kubernetes.io/instance: RELEASE-NAME

  - it: should add extra selector labels with targetDeployment
    set:
      services:
        api:
          targetDeployment: api
          extraSelectorLabels:
            version: v1
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: api
      - equal:
          path: spec.selector.version
          value: v1

  - it: should add extra selector labels without targetDeployment
    set:
      services:
        api:
          extraSelectorLabels:
            version: v1
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: spec.selector.version
          value: v1

  # =========================================================================
  # Labels and annotations
  # =========================================================================
  - it: should set common labels
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: golden-chart
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  - it: should add custom labels
    set:
      services:
        api:
          targetDeployment: api
          labels:
            custom: label
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.labels.custom
          value: label

  - it: should add annotations
    set:
      services:
        api:
          targetDeployment: api
          annotations:
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.annotations["service.beta.kubernetes.io/aws-load-balancer-type"]
          value: "nlb"

  - it: should add global annotations when resource has annotations
    set:
      global:
        annotations:
          global-annotation: global-value
      services:
        api:
          targetDeployment: api
          annotations:
            local: value
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.annotations["global-annotation"]
          value: global-value
      - equal:
          path: metadata.annotations.local
          value: value

  - it: should merge service and global annotations
    set:
      global:
        annotations:
          global-annotation: global-value
      services:
        api:
          targetDeployment: api
          annotations:
            service-annotation: service-value
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - equal:
          path: metadata.annotations["service-annotation"]
          value: service-value
      - equal:
          path: metadata.annotations["global-annotation"]
          value: global-value

  # =========================================================================
  # Multiple services
  # =========================================================================
  - it: should create multiple services
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
        admin:
          targetDeployment: admin
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - hasDocuments:
          count: 2

  - it: should render only enabled services from mix
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: http
        admin:
          enabled: false
          targetDeployment: admin
          ports:
            - name: http
              port: 80
              targetPort: http
    asserts:
      - hasDocuments:
          count: 1

  # =========================================================================
  # Dev values integration
  # =========================================================================
  - it: should create services from dev values
    values:
      - ../examples/values-dev.yaml
    asserts:
      - hasDocuments:
          count: 2
