suite: Test Service Template
templates:
  - service.yaml
tests:
  - it: should create service from dev values
    values:
      - ../examples/values-dev.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-golden-chart-api
      - equal:
          path: spec.type
          value: ClusterIP
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.ports[0].targetPort
          value: http

  - it: should target correct deployment with selector
    values:
      - ../examples/values-dev.yaml
    asserts:
      - equal:
          path: spec.selector
          value:
            app.kubernetes.io/name: golden-chart
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/component: api

  - it: should create service with multiple ports
    set:
      services:
        api:
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
            - name: https
              port: 443
              targetPort: 8443
    asserts:
      - hasDocuments:
          count: 1
      - lengthEqual:
          path: spec.ports
          count: 2
      - equal:
          path: spec.ports[1].name
          value: https
      - equal:
          path: spec.ports[1].port
          value: 443

  - it: should respect enabled flag when false
    set:
      services:
        api:
          enabled: false
          targetDeployment: api
          ports:
            - name: http
              port: 80
    asserts:
      - hasDocuments:
          count: 0

  - it: should support LoadBalancer type
    set:
      services:
        api:
          type: LoadBalancer
          targetDeployment: api
          ports:
            - name: http
              port: 80
              targetPort: 8080
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should add annotations
    set:
      services:
        api:
          targetDeployment: api
          annotations:
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          ports:
            - name: http
              port: 80
    asserts:
      - equal:
          path: metadata.annotations
          value:
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
