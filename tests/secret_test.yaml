suite: Test Secret Template
templates:
  - secret.yaml
tests:
  # =========================================================================
  # Empty / no-render cases
  # =========================================================================
  - it: should not render when secrets is empty
    set:
      secrets: {}
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when secret is disabled
    set:
      secrets:
        app-secrets:
          enabled: false
          stringData:
            API_KEY: "test"
    asserts:
      - hasDocuments:
          count: 0

  - it: should render when enabled is explicitly true
    set:
      secrets:
        app-secrets:
          enabled: true
          stringData:
            API_KEY: "test"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret

  # =========================================================================
  # Naming and namespace
  # =========================================================================
  - it: should set correct resource name
    set:
      secrets:
        app-secrets:
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-golden-chart-app-secrets

  - it: should use fullnameOverride
    set:
      fullnameOverride: custom
      secrets:
        app-secrets:
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.name
          value: custom-app-secrets

  - it: should use namespaceOverride
    set:
      namespaceOverride: custom-ns
      secrets:
        app-secrets:
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-ns

  # =========================================================================
  # Secret type
  # =========================================================================
  - it: should default to Opaque type
    set:
      secrets:
        app-secrets:
          stringData:
            key: value
    asserts:
      - equal:
          path: type
          value: Opaque

  - it: should support custom secret type
    set:
      secrets:
        tls-secret:
          type: kubernetes.io/tls
          data:
            tls.crt: "base64cert"
            tls.key: "base64key"
    asserts:
      - equal:
          path: type
          value: kubernetes.io/tls

  - it: should support docker-registry type
    set:
      secrets:
        registry:
          type: kubernetes.io/dockerconfigjson
          data:
            .dockerconfigjson: "base64data"
    asserts:
      - equal:
          path: type
          value: kubernetes.io/dockerconfigjson

  # =========================================================================
  # Data and stringData
  # =========================================================================
  - it: should set stringData
    set:
      secrets:
        app-secrets:
          stringData:
            API_KEY: "my-api-key"
            DB_PASSWORD: "secret123"
    asserts:
      - equal:
          path: stringData.API_KEY
          value: "my-api-key"
      - equal:
          path: stringData.DB_PASSWORD
          value: "secret123"

  - it: should set data (base64)
    set:
      secrets:
        app-secrets:
          data:
            API_KEY: "bXktYXBpLWtleQ=="
    asserts:
      - equal:
          path: data.API_KEY
          value: "bXktYXBpLWtleQ=="

  - it: should support both data and stringData
    set:
      secrets:
        app-secrets:
          data:
            binary-key: "base64data"
          stringData:
            plain-key: "plain-value"
    asserts:
      - isNotNull:
          path: data
      - isNotNull:
          path: stringData

  - it: should not render data when not specified
    set:
      secrets:
        app-secrets:
          stringData:
            key: value
    asserts:
      - isNull:
          path: data

  - it: should not render stringData when not specified
    set:
      secrets:
        app-secrets:
          data:
            key: "base64data"
    asserts:
      - isNull:
          path: stringData

  # =========================================================================
  # Labels and annotations
  # =========================================================================
  - it: should set common labels
    set:
      secrets:
        app-secrets:
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: golden-chart
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  - it: should add custom labels
    set:
      secrets:
        app-secrets:
          labels:
            custom: label
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.labels.custom
          value: label

  - it: should add annotations
    set:
      secrets:
        app-secrets:
          annotations:
            replicator.v1/replicate-to: "other-namespace"
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.annotations["replicator.v1/replicate-to"]
          value: "other-namespace"

  - it: should add global annotations when resource has annotations
    set:
      global:
        annotations:
          global-annotation: global-value
      secrets:
        app-secrets:
          annotations:
            local: value
          stringData:
            key: value
    asserts:
      - equal:
          path: metadata.annotations["global-annotation"]
          value: global-value
      - equal:
          path: metadata.annotations.local
          value: value

  # =========================================================================
  # Multiple secrets
  # =========================================================================
  - it: should create multiple secrets
    set:
      secrets:
        secret1:
          stringData:
            key1: value1
        secret2:
          stringData:
            key2: value2
    asserts:
      - hasDocuments:
          count: 2

  - it: should render only enabled secrets
    set:
      secrets:
        secret1:
          stringData:
            key1: value1
        secret2:
          enabled: false
          stringData:
            key2: value2
    asserts:
      - hasDocuments:
          count: 1
