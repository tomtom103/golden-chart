suite: Test Extra Resources Template
templates:
  - extra-resources.yaml
tests:
  # =========================================================================
  # Empty / no-render cases
  # =========================================================================
  - it: should not render when extraResources is empty
    set:
      extraResources: []
    asserts:
      - hasDocuments:
          count: 0

  # =========================================================================
  # Single extra resource
  # =========================================================================
  - it: should render a single extra resource
    set:
      extraResources:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: extra-config
          data:
            key: value
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: extra-config
      - equal:
          path: data.key
          value: value

  # =========================================================================
  # Multiple extra resources
  # =========================================================================
  - it: should render multiple extra resources
    set:
      extraResources:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: extra-config
          data:
            key: value
        - apiVersion: v1
          kind: Secret
          metadata:
            name: extra-secret
          type: Opaque
          stringData:
            password: secret
    asserts:
      - hasDocuments:
          count: 2

  # =========================================================================
  # Various resource types
  # =========================================================================
  - it: should render a NetworkPolicy
    set:
      extraResources:
        - apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: deny-all
          spec:
            podSelector: {}
            policyTypes:
              - Ingress
              - Egress
    asserts:
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: deny-all

  - it: should render a PodDisruptionBudget
    set:
      extraResources:
        - apiVersion: policy/v1
          kind: PodDisruptionBudget
          metadata:
            name: api-pdb
          spec:
            minAvailable: 1
            selector:
              matchLabels:
                app: api
    asserts:
      - isKind:
          of: PodDisruptionBudget
      - equal:
          path: spec.minAvailable
          value: 1

  - it: should render a ResourceQuota
    set:
      extraResources:
        - apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: compute-quota
          spec:
            hard:
              requests.cpu: "4"
              requests.memory: 8Gi
    asserts:
      - isKind:
          of: ResourceQuota

  - it: should render a LimitRange
    set:
      extraResources:
        - apiVersion: v1
          kind: LimitRange
          metadata:
            name: default-limits
          spec:
            limits:
              - default:
                  cpu: 500m
                  memory: 512Mi
                type: Container
    asserts:
      - isKind:
          of: LimitRange

  # =========================================================================
  # Complex resources
  # =========================================================================
  - it: should render resource with full metadata
    set:
      extraResources:
        - apiVersion: v1
          kind: ConfigMap
          metadata:
            name: annotated-config
            namespace: custom-ns
            labels:
              app: test
            annotations:
              managed-by: golden-chart
          data:
            key: value
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-ns
      - equal:
          path: metadata.labels.app
          value: test
      - equal:
          path: metadata.annotations.managed-by
          value: golden-chart
