# yaml-language-server: $schema=../values.schema.json
# Development Environment - Data Platform
# Local development with k3s: Metabase dashboard, FastAPI data service, Celery worker

defaults:
  image:
    pullPolicy: Never
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

deployments:
  data-api:
    image:
      repository: data-platform/api
      tag: dev-latest
    ports:
      - name: http
        containerPort: 8000
    env:
      - name: ENVIRONMENT
        value: development
      - name: LOG_LEVEL
        value: debug
      - name: DATABASE_URL
        value: postgresql://postgres:postgres@postgres:5432/dataplatform_dev
      - name: REDIS_URL
        value: redis://redis:6379/0
    livenessProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 10
      periodSeconds: 30
    readinessProbe:
      enabled: true
      httpGet:
        path: /health/ready
        port: http
      initialDelaySeconds: 5
      periodSeconds: 10

  celery-worker:
    image:
      repository: data-platform/api
      tag: dev-latest
    command: ["celery", "-A", "app.worker", "worker", "--loglevel=debug", "--concurrency=2"]
    env:
      - name: ENVIRONMENT
        value: development
      - name: DATABASE_URL
        value: postgresql://postgres:postgres@postgres:5432/dataplatform_dev
      - name: REDIS_URL
        value: redis://redis:6379/0

  metabase:
    image:
      repository: metabase/metabase
      tag: v0.48.0
    ports:
      - name: http
        containerPort: 3000
    env:
      - name: MB_DB_TYPE
        value: postgres
      - name: MB_DB_HOST
        value: postgres
      - name: MB_DB_PORT
        value: "5432"
      - name: MB_DB_DBNAME
        value: metabase
      - name: MB_DB_USER
        value: postgres
      - name: MB_DB_PASS
        value: postgres
    livenessProbe:
      enabled: true
      httpGet:
        path: /api/health
        port: http
      initialDelaySeconds: 60
      periodSeconds: 30
    readinessProbe:
      enabled: true
      httpGet:
        path: /api/health
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10

services:
  data-api:
    type: ClusterIP
    targetDeployment: data-api
    ports:
      - name: http
        port: 80
        targetPort: http

  metabase:
    type: ClusterIP
    targetDeployment: metabase
    ports:
      - name: http
        port: 80
        targetPort: http

configMaps:
  data-api-config:
    data:
      config.yaml: |
        environment: development
        debug: true
        cors_origins:
          - "http://localhost:3000"
          - "http://localhost:8000"
