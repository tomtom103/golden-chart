# Staging Environment Values
# Configuration with Istio service mesh

defaults:
  image:
    pullPolicy: Never
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  securityContext:
    runAsNonRoot: true
    runAsUser: 1001
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

deployments:
  api:
    replicas: 2
    image:
      repository: myapp/api
      tag: v1.2.0
    ports:
      - name: http
        containerPort: 8080
      - name: metrics
        containerPort: 9090
    env:
      - name: NODE_ENV
        value: staging
      - name: LOG_LEVEL
        value: info
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: db-credentials
            key: url
    volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: cache
        mountPath: /app/cache
    volumes:
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}
    livenessProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      enabled: true
      httpGet:
        path: /ready
        port: http
      initialDelaySeconds: 10
      periodSeconds: 5
    startupProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      failureThreshold: 30
      periodSeconds: 5

  worker:
    replicas: 2
    image:
      repository: myapp/worker
      tag: v1.2.0
    command: ["node", "worker.js"]
    env:
      - name: NODE_ENV
        value: staging
      - name: QUEUE_URL
        valueFrom:
          secretKeyRef:
            name: redis-credentials
            key: url

services:
  api:
    type: ClusterIP
    targetDeployment: api
    ports:
      - name: http
        port: 80
        targetPort: http
      - name: metrics
        port: 9090
        targetPort: metrics

configMaps:
  app-config:
    data:
      config.json: |
        {
          "environment": "staging",
          "features": {
            "new_ui": true,
            "debug_mode": false
          }
        }

secrets:
  api-secrets:
    stringData:
      api-key: "staging-api-key-example"

horizontalPodAutoscalers:
  api:
    targetDeployment: api
    minReplicas: 2
    maxReplicas: 5
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/myapp-staging"

istio:
  enabled: true
  
  gateways:
    main:
      servers:
        - port:
            number: 80
            name: http
            protocol: HTTP
          hosts:
            - "staging.myapp.com"
  
  virtualServices:
    api:
      hosts:
        - "staging.myapp.com"
      gateways:
        - main
      http:
        - match:
            - uri:
                prefix: "/"
          route:
            - destination:
                host: api
                port:
                  number: 80
  
  destinationRules:
    api:
      host: api
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
