# yaml-language-server: $schema=../values.schema.json
# Staging Environment - Data Platform
# Istio routing, HPA, startup probes, dbt scheduled runs

defaults:
  image:
    pullPolicy: IfNotPresent
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  securityContext:
    runAsNonRoot: true
    runAsUser: 1001
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

deployments:
  data-api:
    replicas: 2
    image:
      repository: data-platform/api
      tag: v2.1.0
    ports:
      - name: http
        containerPort: 8000
      - name: metrics
        containerPort: 9090
    env:
      - name: ENVIRONMENT
        value: staging
      - name: LOG_LEVEL
        value: info
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: db-credentials
            key: url
      - name: REDIS_URL
        valueFrom:
          secretKeyRef:
            name: redis-credentials
            key: url
    volumeMounts:
      - name: tmp
        mountPath: /tmp
    volumes:
      - name: tmp
        emptyDir: {}
    livenessProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      enabled: true
      httpGet:
        path: /health/ready
        port: http
      initialDelaySeconds: 10
      periodSeconds: 5
    startupProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      failureThreshold: 30
      periodSeconds: 5

  celery-worker:
    replicas: 2
    image:
      repository: data-platform/api
      tag: v2.1.0
    command: ["celery", "-A", "app.worker", "worker", "--loglevel=info", "--concurrency=4"]
    env:
      - name: ENVIRONMENT
        value: staging
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: db-credentials
            key: url
      - name: REDIS_URL
        valueFrom:
          secretKeyRef:
            name: redis-credentials
            key: url
    volumeMounts:
      - name: tmp
        mountPath: /tmp
    volumes:
      - name: tmp
        emptyDir: {}

  metabase:
    replicas: 1
    image:
      repository: metabase/metabase
      tag: v0.48.0
    ports:
      - name: http
        containerPort: 3000
    env:
      - name: MB_DB_TYPE
        value: postgres
      - name: MB_DB_CONNECTION_URI
        valueFrom:
          secretKeyRef:
            name: metabase-db-credentials
            key: uri
    volumeMounts:
      - name: tmp
        mountPath: /tmp
    volumes:
      - name: tmp
        emptyDir: {}
    livenessProbe:
      enabled: true
      httpGet:
        path: /api/health
        port: http
      initialDelaySeconds: 60
      periodSeconds: 30
    readinessProbe:
      enabled: true
      httpGet:
        path: /api/health
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10

services:
  data-api:
    type: ClusterIP
    targetDeployment: data-api
    ports:
      - name: http
        port: 80
        targetPort: http
      - name: metrics
        port: 9090
        targetPort: metrics

  metabase:
    type: ClusterIP
    targetDeployment: metabase
    ports:
      - name: http
        port: 80
        targetPort: http

configMaps:
  data-api-config:
    data:
      config.yaml: |
        environment: staging
        debug: false
        cors_origins:
          - "https://staging.data-platform.example.com"

horizontalPodAutoscalers:
  data-api:
    targetDeployment: data-api
    minReplicas: 2
    maxReplicas: 6
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70

cronjobs:
  dbt-run:
    schedule: "0 */4 * * *"
    concurrencyPolicy: Forbid
    image:
      repository: data-platform/dbt-runner
      tag: v2.1.0
    command: ["dbt", "run", "--target", "staging"]
    env:
      - name: DBT_PROFILES_DIR
        value: /app/profiles
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: db-credentials
            key: url

istio:
  enabled: true

  gateways:
    main:
      selector:
        istio: ingressgateway
      servers:
        - port:
            number: 80
            name: http
            protocol: HTTP
          hosts:
            - "staging.data-platform.example.com"

  virtualServices:
    data-api:
      hosts:
        - "staging.data-platform.example.com"
      gateways:
        - main
      http:
        - match:
            - uri:
                prefix: "/api"
          route:
            - destination:
                host: data-api
                port:
                  number: 80
        - match:
            - uri:
                prefix: "/"
          route:
            - destination:
                host: metabase
                port:
                  number: 80

  destinationRules:
    data-api:
      host: data-api
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
