# Production Environment Values
# Full production configuration with HA and Istio

defaults:
  image:
    pullPolicy: Never
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi
  securityContext:
    runAsNonRoot: true
    runAsUser: 1001
    fsGroup: 1001
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    seccompProfile:
      type: RuntimeDefault
    capabilities:
      drop:
        - ALL

deployments:
  api:
    replicas: 5
    image:
      repository: myapp/api
      tag: v1.2.0
    ports:
      - name: http
        containerPort: 8080
      - name: metrics
        containerPort: 9090
    env:
      - name: NODE_ENV
        value: production
      - name: LOG_LEVEL
        value: warn
      - name: LOG_FORMAT
        value: json
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: db-credentials
            key: url
    volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: cache
        mountPath: /app/cache
    volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi
      - name: cache
        emptyDir:
          sizeLimit: 500Mi
    livenessProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      enabled: true
      httpGet:
        path: /ready
        port: http
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
    startupProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 60
    lifecycle:
      preStop:
        exec:
          command: ["/bin/sh", "-c", "sleep 15"]

  worker:
    replicas: 3
    image:
      repository: myapp/worker
      tag: v1.2.0
    command: ["node", "worker.js"]
    env:
      - name: NODE_ENV
        value: production
      - name: QUEUE_URL
        valueFrom:
          secretKeyRef:
            name: redis-credentials
            key: url
      - name: CONCURRENCY
        value: "10"
    volumeMounts:
      - name: tmp
        mountPath: /tmp
    volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi

services:
  api:
    type: ClusterIP
    targetDeployment: api
    ports:
      - name: http
        port: 80
        targetPort: http
      - name: metrics
        port: 9090
        targetPort: metrics

configMaps:
  app-config:
    data:
      config.json: |
        {
          "environment": "production",
          "features": {
            "new_ui": true,
            "experimental_features": false,
            "rate_limiting": true
          },
          "monitoring": {
            "metrics_enabled": true,
            "tracing_sample_rate": 0.1
          }
        }

horizontalPodAutoscalers:
  api:
    targetDeployment: api
    minReplicas: 5
    maxReplicas: 20
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 60
      - type: Resource
        resource:
          name: memory
          target:
            type: Utilization
            averageUtilization: 70
    behavior:
      scaleUp:
        stabilizationWindowSeconds: 60
        policies:
          - type: Percent
            value: 50
            periodSeconds: 60
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 10
            periodSeconds: 60

  worker:
    targetDeployment: worker
    minReplicas: 3
    maxReplicas: 10
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70

cronjobs:
  cleanup:
    schedule: "0 2 * * *"  # Daily at 2 AM
    image:
      repository: myapp/cleanup
      tag: latest

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/myapp-production"
    iam.gke.io/gcp-service-account: "myapp-prod@project-id.iam.gserviceaccount.com"

istio:
  enabled: true
  
  gateways:
    main:
      servers:
        - port:
            number: 443
            name: https
            protocol: HTTPS
          hosts:
            - "api.myapp.com"
          tls:
            mode: SIMPLE
            credentialName: production-tls
  
  virtualServices:
    api:
      hosts:
        - "api.myapp.com"
      gateways:
        - main
      http:
        - match:
            - uri:
                prefix: "/api/v1"
          route:
            - destination:
                host: api
                port:
                  number: 80
          retries:
            attempts: 3
            perTryTimeout: 3s
            retryOn: "5xx,reset,connect-failure,refused-stream"
          timeout: 10s
  
  destinationRules:
    api:
      host: api
      trafficPolicy:
        connectionPool:
          tcp:
            maxConnections: 200
          http:
            http1MaxPendingRequests: 100
            http2MaxRequests: 200
        loadBalancer:
          consistentHash:
            httpHeaderName: x-user-id
        outlierDetection:
          consecutiveErrors: 5
          interval: 30s
          baseEjectionTime: 30s
          maxEjectionPercent: 50
